@* Interactive Track Map with Live Car Position *@

<div class="track-container glass-card">
    <div style="position: relative;">
        <img src="/images/cota_track.svg" alt="COTA Track" class="track-svg" />

        @if (currentPosition != null)
        {
            <div class="car-dot" style="left: @(currentPosition.Value.X)px; top: @(currentPosition.Value.Y)px;">
            </div>
        }

        @if (showSectorInfo && currentTelemetry != null)
        {
            <MudPaper Class="glass-card pa-3" Style="position: absolute; top: 10px; right: 10px; min-width: 200px;">
                <MudText Typo="Typo.h6">Live Telemetry</MudText>
                <MudDivider Class="my-2"/>
                <MudText Typo="Typo.body2">
                    <strong>Sector:</strong> @currentTelemetry.CurrentSector<br/>
                    <strong>Speed:</strong> @($"{currentTelemetry.Speed:F1}") km/h<br/>
                    <strong>Gear:</strong> @currentTelemetry.Gear<br/>
                    <strong>Throttle:</strong> @($"{currentTelemetry.Throttle:F1}")%<br/>
                    <strong>Brake:</strong> @($"{currentTelemetry.BrakeFront:F1}")
                </MudText>
            </MudPaper>
        }

        @if (sectorDeltas != null && sectorDeltas.Any())
        {
            <div style="position: absolute; bottom: 10px; left: 10px; display: flex; gap: 10px;">
                @foreach (var delta in sectorDeltas)
                {
                    var colorClass = delta.Status switch
                    {
                        SectorStatus.Green => "sector-green",
                        SectorStatus.Yellow => "sector-yellow",
                        _ => "sector-red"
                    };

                    <MudPaper Class="@($"glass-card pa-2 {colorClass}")" Style="min-width: 80px;">
                        <MudText Typo="Typo.caption" Align="Align.Center">
                            <strong>S@delta.Sector</strong><br/>
                            @($"{delta.Delta.TotalSeconds:+0.00;-0.00}s")
                        </MudText>
                    </MudPaper>
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public TrackPosition? TrackPosition { get; set; }
    [Parameter] public TelemetryRecord? currentTelemetry { get; set; }
    [Parameter] public List<SectorDelta>? sectorDeltas { get; set; }
    [Parameter] public bool showSectorInfo { get; set; } = true;

    private (double X, double Y)? currentPosition;

    protected override void OnParametersSet()
    {
        if (TrackPosition != null)
        {
            currentPosition = TrackPosition.PixelPosition;
        }
    }
}
